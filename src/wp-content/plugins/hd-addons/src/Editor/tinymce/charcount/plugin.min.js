(function () {
    tinymce.PluginManager.add('charcount', function (editor) {
        function countCharacters(content) {
            let total = 0;
            for (const char of content) {
                if (/[\u0000-\u001F\u007F\uFFFD]/.test(char)) continue;
                total++;
            }
            return total;
        }

        function updateCount() {
            const content = editor.getContent({ format: 'text' });
            const totalCharacters = countCharacters(content);
            const statusbar = editor.theme.panel && editor.theme.panel.find("#statusbar")[0];
            if (statusbar) {
                const charcountLabel = editor.theme.panel.find('#charcount');
                if (charcountLabel) {
                    charcountLabel.text(`Characters: ${totalCharacters}`);
                }
            }
        }

        editor.on('init', function () {
            const statusbar = editor.theme.panel && editor.theme.panel.find("#statusbar")[0];
            if (statusbar) {
                setTimeout(function () {
                    statusbar.insert({
                        type: 'label',
                        name: 'charcount',
                        text: 'Characters: 0',
                        classes: 'charcount',
                        disabled: editor.settings.readonly
                    }, 0);
                    updateCount();
                    editor.on('setcontent beforeaddundo undo redo keyup change', function () {
                        setTimeout(updateCount, 1000);
                    });
                }, 0);
            }
        });
    });
})();
